<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>scPLAN Annotation Guidelines &mdash; scplan</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="scPLAN Annotation Guidelines" href="scPLAN_Annotation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../index.html" class="icon icon-home">
            scplan
              <img src="../_static/scPLAN.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Welcome to scplan's documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">APIs in scPLAN</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tut.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="scPLAN_Annotation.html">scPLAN Annotation Guidelines</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">scPLAN Annotation Guidelines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#1.-Module-dependencies">1. Module dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2.-Param-settings-and-data-preparation">2. Param settings and data preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#3.-Initialization-of-scPLAN-module">3. Initialization of scPLAN module</a></li>
<li class="toctree-l3"><a class="reference internal" href="#4.-scPLAN-training">4. scPLAN training</a></li>
<li class="toctree-l3"><a class="reference internal" href="#5.-Downstream-analysis">5. Downstream analysis</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">scplan</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tut.html">Tutorial</a></li>
      <li class="breadcrumb-item active">scPLAN Annotation Guidelines</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/michaelGuo1204/scPLAN/blob/main/docs/source/Tutorial/scPLAN_Integration.ipynb" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="scPLAN-Annotation-Guidelines">
<h1>scPLAN Annotation Guidelines<a class="headerlink" href="#scPLAN-Annotation-Guidelines" title="Permalink to this heading"></a></h1>
<p>In this tutorial, we will introduce the basic usage of scPLAN on integration task.</p>
<section id="1.-Module-dependencies">
<h2>1. Module dependencies<a class="headerlink" href="#1.-Module-dependencies" title="Permalink to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scplan.PLL</span> <span class="kn">import</span> <span class="n">PartialLabelLearning</span>
<span class="kn">from</span> <span class="nn">scplan.Param</span> <span class="kn">import</span> <span class="n">Param</span>
<span class="kn">from</span> <span class="nn">scplan.Encoder</span> <span class="kn">import</span> <span class="n">ZINBEncoder</span>
<span class="kn">from</span> <span class="nn">scplan.DataWork.Atlas</span> <span class="kn">import</span> <span class="n">AtlasDataset</span>
<span class="kn">from</span> <span class="nn">scplan.DataWork.sankey</span> <span class="kn">import</span> <span class="n">sankey</span>
<span class="kn">import</span> <span class="nn">lightning.pytorch</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">treelib</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/pydantic/_internal/_fields.py:127: UserWarning: Field &#34;model_server_url&#34; has conflict with protected namespace &#34;model_&#34;.

You may be able to resolve this warning by setting `model_config[&#39;protected_namespaces&#39;] = ()`.
  warnings.warn(
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/pydantic/_internal/_config.py:269: UserWarning: Valid config keys have changed in V2:
* &#39;schema_extra&#39; has been renamed to &#39;json_schema_extra&#39;
  warnings.warn(message, UserWarning)
</pre></div></div>
</div>
</section>
<section id="2.-Param-settings-and-data-preparation">
<h2>2. Param settings and data preparation<a class="headerlink" href="#2.-Param-settings-and-data-preparation" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param</span> <span class="o">=</span> <span class="n">Param</span><span class="p">()</span>
<span class="n">param</span><span class="o">.</span><span class="n">datapath</span> <span class="o">=</span> <span class="s2">&quot;/home/bili/Lernen/PLL/Data/PBMCInter/&quot;</span> <span class="c1"># Data path</span>
<span class="n">param</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;PBMCInter_eQTL.h5ad&quot;</span>                     <span class="c1"># Specify datasets</span>
<span class="n">param</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="s2">&quot;PBMCInter_FACS.h5ad&quot;</span>
<span class="n">param</span><span class="o">.</span><span class="n">pretrain_epoch</span> <span class="o">=</span> <span class="mi">30</span>                                <span class="c1"># Maximal ZINB pretraining epochs</span>
<span class="n">param</span><span class="o">.</span><span class="n">enc_dim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">256</span><span class="p">]</span>                                    <span class="c1"># Encoder hidden layer size</span>
<span class="n">param</span><span class="o">.</span><span class="n">dec_dim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">256</span><span class="p">]</span>                                    <span class="c1"># Decoder hidden layer size</span>
<span class="n">param</span><span class="o">.</span><span class="n">latent_dim</span> <span class="o">=</span> <span class="mi">64</span>                                    <span class="c1"># Latent size</span>
<span class="n">param</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">150</span><span class="p">]</span>                              <span class="c1"># Training epochs and its stages</span>
<span class="n">param</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1024</span>                                  <span class="c1"># Config batch size</span>
<span class="n">param</span><span class="o">.</span><span class="n">moco_queue</span> <span class="o">=</span> <span class="mi">2048</span>                                  <span class="c1"># Config pool size for contrastive learning</span>
<span class="n">param</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-4</span>                                          <span class="c1"># Overall learning rate</span>
<span class="n">param</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>                                       <span class="c1"># CUDA device for training</span>
</pre></div>
</div>
</div>
<blockquote>
<div><p>NOTE!: scPLAN will automatically generate tree for integration task by scHPL, but you could also specify your tree for label as shown in the following block</p>
</div></blockquote>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">treelib</span><span class="o">.</span><span class="n">Tree</span><span class="p">()</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;B cell - FACS&quot;</span><span class="p">,</span> <span class="s2">&quot;bcfacs&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;B cell - eQTL&quot;</span><span class="p">,</span> <span class="s2">&quot;bceQTL&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;CD14+ Monocyte - FACS&quot;</span><span class="p">,</span> <span class="s2">&quot;mo&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;CD14+ Monocyte - eQTL&quot;</span><span class="p">,</span> <span class="s2">&quot;cmo&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;mo&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;CD16+ Monocyte - eQTL&quot;</span><span class="p">,</span> <span class="s2">&quot;ncmo&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;mo&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;mDC - eQTL&quot;</span><span class="p">,</span> <span class="s2">&quot;mdc&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;mo&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;CD34+ cell - FACS&quot;</span><span class="p">,</span> <span class="s2">&quot;cd34&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;Megakaryocyte - eQTL&quot;</span><span class="p">,</span> <span class="s2">&quot;mk&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;cd34&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;pDC - eQTL&quot;</span><span class="p">,</span> <span class="s2">&quot;pdc&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;cd34&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;CD4+ T cell - eQTL&quot;</span><span class="p">,</span> <span class="s2">&quot;tc&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;CD4+/CD25 T Reg - FACS&quot;</span><span class="p">,</span> <span class="s2">&quot;treg&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;tc&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;CD4+/CD45RA+/CD25- Naive T - FACS&quot;</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;tc&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;CD4+/CD45RO+ Memory - FACS&quot;</span><span class="p">,</span> <span class="s2">&quot;tm&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;tc&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;CD8+/CD45RA+ Naive Cytotoxic - FACS&quot;</span><span class="p">,</span> <span class="s2">&quot;tcy&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;tc&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;NK cell - FACS&quot;</span><span class="p">,</span> <span class="s2">&quot;nk&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;CD56+ bright NK cell - eQTL&quot;</span><span class="p">,</span> <span class="s2">&quot;bnk&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;nk&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;CD56+ dim NK cell - eQTL&quot;</span><span class="p">,</span> <span class="s2">&quot;dnk&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;nk&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s2">&quot;CD8+ T cell - eQTL&quot;</span><span class="p">,</span> <span class="s2">&quot;cd8&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;nk&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
root
├── B cell - FACS
├── B cell - eQTL
├── CD14+ Monocyte - FACS
│   ├── CD14+ Monocyte - eQTL
│   ├── CD16+ Monocyte - eQTL
│   └── mDC - eQTL
├── CD34+ cell - FACS
│   ├── Megakaryocyte - eQTL
│   └── pDC - eQTL
├── CD4+ T cell - eQTL
│   ├── CD4+/CD25 T Reg - FACS
│   ├── CD4+/CD45RA+/CD25- Naive T - FACS
│   ├── CD4+/CD45RO+ Memory - FACS
│   └── CD8+/CD45RA+ Naive Cytotoxic - FACS
└── NK cell - FACS
    ├── CD56+ bright NK cell - eQTL
    ├── CD56+ dim NK cell - eQTL
    └── CD8+ T cell - eQTL
</pre></div></div>
</div>
<p>Initialization of dataset and scPLAN module</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">AtlasDataset</span><span class="p">(</span><span class="n">data_path</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span><span class="n">target</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">target</span><span class="p">,</span><span class="n">ref</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">tree</span><span class="o">=</span><span class="n">tree</span><span class="p">)</span>
<span class="n">param</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">updateParams</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
<span class="n">pll</span> <span class="o">=</span> <span class="n">PartialLabelLearning</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/scanpy/preprocessing/_simple.py:351: RuntimeWarning: invalid value encountered in log1p
  np.log1p(X, out=X)
/home/bili/Lernen/PLL/plan/DataWork/Atlas.py:155: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  partialY[j, :] = (transition_matrix[train_label[j], :])
/home/bili/Lernen/PLL/plan/DataWork/Atlas.py:88: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  partial_Y[ref_index,:] = torch.from_numpy(ref_partial_Y).float()
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([4., 5., 0., 0., 0., 1., 1., 2., 2., 2., 2., 3., 3., 3.])
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bili/Lernen/PLL/plan/DataWork/Atlas.py:89: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  partial_Y[target_index,:] = torch.from_numpy(target_partial_Y).float()
</pre></div></div>
</div>
</section>
<section id="3.-Initialization-of-scPLAN-module">
<h2>3. Initialization of scPLAN module<a class="headerlink" href="#3.-Initialization-of-scPLAN-module" title="Permalink to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pll</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">ZINBEncoder</span><span class="p">,</span><span class="n">pretrain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
runid: 968f49c03c5148ddb3d559f8cbd3e7d9
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bili/Lernen/PLL/plan/DataWork/utils.py:33: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  self.size_factor = torch.Tensor(values.obs[&#34;size_factor&#34;])      # Compute size factor
/home/bili/Lernen/PLL/plan/DataWork/utils.py:38: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  self.cell_label = torch.Tensor(values.obs[&#34;cell_label&#34;]).int()  # Initialize ground truth label
GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/lightning/pytorch/loops/fit_loop.py:293: The number of training batches (20) is smaller than the logging interval Trainer(log_every_n_steps=50). Set a lower value for log_every_n_steps if you want to see logs for the training epoch.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "0f69fd4043ec44c99e3fc67181396226"}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/lightning/pytorch/utilities/data.py:77: Trying to infer the `batch_size` from an ambiguous collection. The batch size we found is 1024. To avoid any miscalculations, use `self.log(..., batch_size=batch_size)`.
`Trainer.fit` stopped: `max_steps=100` reached.
Learning rate set to 0.00020892961308540398
Restoring states from the checkpoint path at /home/bili/Lernen/PLL/Experiments/MultiDataset/scHPL/PBMCInter/.lr_find_f5148125-a167-4054-a921-87cde7226986.ckpt
Restored all states from the checkpoint at /home/bili/Lernen/PLL/Experiments/MultiDataset/scHPL/PBMCInter/.lr_find_f5148125-a167-4054-a921-87cde7226986.ckpt

  | Name  | Type            | Params
------------------------------------------
0 | AE    | ZINBAutoEncoder | 2.1 M
1 | zloss | ZINBLoss        | 0
------------------------------------------
2.1 M     Trainable params
0         Non-trainable params
2.1 M     Total params
8.353     Total estimated model params size (MB)
Restored all states from the checkpoint at /home/bili/Lernen/PLL/Experiments/MultiDataset/scHPL/PBMCInter/.lr_find_f5148125-a167-4054-a921-87cde7226986.ckpt
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "6d8a88875ef64129838818b4b6c58b08"}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
`Trainer.fit` stopped: `max_epochs=30` reached.
</pre></div></div>
</div>
</section>
<section id="4.-scPLAN-training">
<h2>4. scPLAN training<a class="headerlink" href="#4.-scPLAN-training" title="Permalink to this heading"></a></h2>
<p>In this section we train scPLAN in a two-layer scheme</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stage_1_trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">max_epochs</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">epochs</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">devices</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="n">stage_1_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pll</span><span class="p">)</span>
<span class="n">stage_1_trainer</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="s2">&quot;stage1.ckpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/lightning/pytorch/callbacks/model_checkpoint.py:634: Checkpoint directory /home/bili/Lernen/PLL/Experiments/MultiDataset/scHPL/PBMCInter/22/968f49c03c5148ddb3d559f8cbd3e7d9/checkpoints exists and is not empty.
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name  | Type  | Params
--------------------------------
0 | model | Model | 4.2 M
--------------------------------
2.1 M     Trainable params
2.1 M     Non-trainable params
4.2 M     Total params
16.706    Total estimated model params size (MB)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "e5c76fa423df44968ff19f5f52c37ed0"}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
`Trainer.fit` stopped: `max_epochs=100` reached.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_loader</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">pred_trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="n">stage_1_pred_out</span> <span class="o">=</span> <span class="n">pred_trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pll</span><span class="p">,</span><span class="n">pred_loader</span><span class="p">)</span>
<span class="n">stage_1_pred_data</span> <span class="o">=</span> <span class="n">pll</span><span class="o">.</span><span class="n">getPredictions</span><span class="p">(</span><span class="n">stage_1_pred_out</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bili/Lernen/PLL/plan/DataWork/utils.py:33: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  self.size_factor = torch.Tensor(values.obs[&#34;size_factor&#34;])      # Compute size factor
/home/bili/Lernen/PLL/plan/DataWork/utils.py:38: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  self.cell_label = torch.Tensor(values.obs[&#34;cell_label&#34;]).int()  # Initialize ground truth label
GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/logger_connector/logger_connector.py:67: Starting from v1.9.0, `tensorboardX` has been removed as a dependency of the `lightning.pytorch` package, due to potential conflicts with other packages in the ML ecosystem. For this reason, `logger=True` will use `CSVLogger` as the default logger, unless the `tensorboard` or `tensorboardX` packages are found. Please `pip install lightning[extra]` or one of them to enable TensorBoard support by default
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:492: Your `predict_dataloader`&#39;s sampler has shuffling enabled, it is strongly recommended that you turn shuffling off for val/test dataloaders.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "448114b088d048eaa0945512baeeef57"}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stage_2_trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">max_epochs</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">epochs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span><span class="n">devices</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="n">stage_2_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pll</span><span class="p">,</span><span class="n">ckpt_path</span><span class="o">=</span><span class="s2">&quot;stage1.ckpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/lightning/pytorch/callbacks/model_checkpoint.py:634: Checkpoint directory /home/bili/Lernen/PLL/Experiments/MultiDataset/scHPL/PBMCInter/22/968f49c03c5148ddb3d559f8cbd3e7d9/checkpoints exists and is not empty.
Restoring states from the checkpoint path at stage1.ckpt
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name  | Type  | Params
--------------------------------
0 | model | Model | 4.2 M
--------------------------------
2.1 M     Trainable params
2.1 M     Non-trainable params
4.2 M     Total params
16.706    Total estimated model params size (MB)
Restored all states from the checkpoint at stage1.ckpt
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/lightning/pytorch/loops/fit_loop.py:293: The number of training batches (20) is smaller than the logging interval Trainer(log_every_n_steps=50). Set a lower value for log_every_n_steps if you want to see logs for the training epoch.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "833727779ff94b9b8fa35f7a20f23c43"}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Updating label clusters
tensor([ 0.,  1.,  2.,  3.,  4.,  5.,  6.,  7.,  8.,  9., 10., 11., 12., 13.])
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
`Trainer.fit` stopped: `max_epochs=150` reached.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_loader</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">pred_trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="n">stage_2_pred_out</span> <span class="o">=</span> <span class="n">pred_trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pll</span><span class="p">,</span><span class="n">pred_loader</span><span class="p">)</span>
<span class="n">stage_2_pred_data</span> <span class="o">=</span> <span class="n">pll</span><span class="o">.</span><span class="n">getPredictions</span><span class="p">(</span><span class="n">stage_2_pred_out</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bili/Lernen/PLL/plan/DataWork/utils.py:33: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  self.size_factor = torch.Tensor(values.obs[&#34;size_factor&#34;])      # Compute size factor
/home/bili/Lernen/PLL/plan/DataWork/utils.py:38: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  self.cell_label = torch.Tensor(values.obs[&#34;cell_label&#34;]).int()  # Initialize ground truth label
GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:492: Your `predict_dataloader`&#39;s sampler has shuffling enabled, it is strongly recommended that you turn shuffling off for val/test dataloaders.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "960b9093a2c34b16b1bad065115dbcd3"}</script></div>
</div>
</section>
<section id="5.-Downstream-analysis">
<h2>5. Downstream analysis<a class="headerlink" href="#5.-Downstream-analysis" title="Permalink to this heading"></a></h2>
<p>After training, we could extract scPLAN’s latent and perform downstream analysis</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">true_label</span> <span class="o">=</span> <span class="n">stage_1_pred_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">pred_label</span> <span class="o">=</span> <span class="n">stage_1_pred_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">true_label</span><span class="p">,</span><span class="n">pred_label</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred_label</span> <span class="o">==</span> <span class="n">true_label</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accurarcy: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">accuracy</span><span class="p">))</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">sankey</span><span class="p">(</span><span class="n">true_label</span><span class="p">,</span> <span class="n">pred_label</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Accurarcy: 0.5591850086452638
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Tutorial_scPLAN_Integration_16_1.png" src="../_images/Tutorial_scPLAN_Integration_16_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">stage_1_pred_data</span><span class="p">,</span><span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;latent&quot;</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">stage_1_pred_data</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">stage_2_pred_data</span><span class="p">,</span><span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;latent&quot;</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">stage_2_pred_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/umap/distances.py:1063: NumbaDeprecationWarning: <span class="ansi-bold">The &#39;nopython&#39; keyword argument was not supplied to the &#39;numba.jit&#39; decorator. The implicit default value for this argument is currently False, but it will be changed to True in Numba 0.59.0. See https://numba.readthedocs.io/en/stable/reference/deprecation.html#deprecation-of-object-mode-fall-back-behaviour-when-using-jit for details.</span>
  @numba.jit()
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/umap/distances.py:1071: NumbaDeprecationWarning: <span class="ansi-bold">The &#39;nopython&#39; keyword argument was not supplied to the &#39;numba.jit&#39; decorator. The implicit default value for this argument is currently False, but it will be changed to True in Numba 0.59.0. See https://numba.readthedocs.io/en/stable/reference/deprecation.html#deprecation-of-object-mode-fall-back-behaviour-when-using-jit for details.</span>
  @numba.jit()
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/umap/distances.py:1086: NumbaDeprecationWarning: <span class="ansi-bold">The &#39;nopython&#39; keyword argument was not supplied to the &#39;numba.jit&#39; decorator. The implicit default value for this argument is currently False, but it will be changed to True in Numba 0.59.0. See https://numba.readthedocs.io/en/stable/reference/deprecation.html#deprecation-of-object-mode-fall-back-behaviour-when-using-jit for details.</span>
  @numba.jit()
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/umap/umap_.py:660: NumbaDeprecationWarning: <span class="ansi-bold">The &#39;nopython&#39; keyword argument was not supplied to the &#39;numba.jit&#39; decorator. The implicit default value for this argument is currently False, but it will be changed to True in Numba 0.59.0. See https://numba.readthedocs.io/en/stable/reference/deprecation.html#deprecation-of-object-mode-fall-back-behaviour-when-using-jit for details.</span>
  @numba.jit()
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/pynndescent/pynndescent_.py:346: NumbaPendingDeprecationWarning: <span class="ansi-bold">Code using Numba extension API maybe depending on &#39;old_style&#39; error-capturing, which is deprecated and will be replaced by &#39;new_style&#39; in a future release. See details at https://numba.readthedocs.io/en/latest/reference/deprecation.html#deprecation-of-old-style-numba-captured-errors
Exception origin:
  File &#34;/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/numba/core/types/functions.py&#34;, line 486, in __getnewargs__
    raise ReferenceError(&#34;underlying object has vanished&#34;)
</span>
  init_rp_tree(data, dist, current_graph, leaf_array)
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/pynndescent/pynndescent_.py:348: NumbaPendingDeprecationWarning: <span class="ansi-bold">Code using Numba extension API maybe depending on &#39;old_style&#39; error-capturing, which is deprecated and will be replaced by &#39;new_style&#39; in a future release. See details at https://numba.readthedocs.io/en/latest/reference/deprecation.html#deprecation-of-old-style-numba-captured-errors
Exception origin:
  File &#34;/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/numba/core/types/functions.py&#34;, line 486, in __getnewargs__
    raise ReferenceError(&#34;underlying object has vanished&#34;)
</span>
  init_random(n_neighbors, data, current_graph, dist, rng_state)
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/pynndescent/pynndescent_.py:358: NumbaPendingDeprecationWarning: <span class="ansi-bold">Code using Numba extension API maybe depending on &#39;old_style&#39; error-capturing, which is deprecated and will be replaced by &#39;new_style&#39; in a future release. See details at https://numba.readthedocs.io/en/latest/reference/deprecation.html#deprecation-of-old-style-numba-captured-errors
Exception origin:
  File &#34;/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/numba/core/types/functions.py&#34;, line 486, in __getnewargs__
    raise ReferenceError(&#34;underlying object has vanished&#34;)
</span>
  nn_descent_internal_low_memory_parallel(
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">stage_1_pred_data</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cell_type&quot;</span><span class="p">])</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">stage_1_pred_data</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/scanpy/plotting/_tools/scatterplots.py:1251: FutureWarning: The default value of &#39;ignore&#39; for the `na_action` parameter in pandas.Categorical.map is deprecated and will be changed to &#39;None&#39; in a future version. Please set na_action to the desired value to avoid seeing this warning
  color_vector = pd.Categorical(values.map(color_map))
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/scanpy/plotting/_tools/scatterplots.py:394: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Tutorial_scPLAN_Integration_18_1.png" src="../_images/Tutorial_scPLAN_Integration_18_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/scanpy/plotting/_tools/scatterplots.py:1251: FutureWarning: The default value of &#39;ignore&#39; for the `na_action` parameter in pandas.Categorical.map is deprecated and will be changed to &#39;None&#39; in a future version. Please set na_action to the desired value to avoid seeing this warning
  color_vector = pd.Categorical(values.map(color_map))
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/scanpy/plotting/_tools/scatterplots.py:394: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Tutorial_scPLAN_Integration_18_3.png" src="../_images/Tutorial_scPLAN_Integration_18_3.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">stage_2_pred_data</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cell_type&quot;</span><span class="p">])</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">stage_2_pred_data</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/scanpy/plotting/_tools/scatterplots.py:1251: FutureWarning: The default value of &#39;ignore&#39; for the `na_action` parameter in pandas.Categorical.map is deprecated and will be changed to &#39;None&#39; in a future version. Please set na_action to the desired value to avoid seeing this warning
  color_vector = pd.Categorical(values.map(color_map))
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/scanpy/plotting/_tools/scatterplots.py:394: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Tutorial_scPLAN_Integration_19_1.png" src="../_images/Tutorial_scPLAN_Integration_19_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/scanpy/plotting/_tools/scatterplots.py:1251: FutureWarning: The default value of &#39;ignore&#39; for the `na_action` parameter in pandas.Categorical.map is deprecated and will be changed to &#39;None&#39; in a future version. Please set na_action to the desired value to avoid seeing this warning
  color_vector = pd.Categorical(values.map(color_map))
/home/bili/Apps/Mamba/envs/PLL/lib/python3.11/site-packages/scanpy/plotting/_tools/scatterplots.py:394: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Tutorial_scPLAN_Integration_19_3.png" src="../_images/Tutorial_scPLAN_Integration_19_3.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="scPLAN_Annotation.html" class="btn btn-neutral float-left" title="scPLAN Annotation Guidelines" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, michaelGuo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>